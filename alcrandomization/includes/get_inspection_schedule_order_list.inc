<?php

function get_inspection_schedule_order_list(){
	
	$markupLink				=	get_order_alc_dlc();
	
	$form['markup-link']	=	array(
									'#type'		=>	'markup',
									'#markup'	=>	$markupLink,
									'#prefix'	=> '<div class="row"><div class="col-md-12"><div class="box box-primary"><div class="box-body">',	
									'#suffix'	=> '</div></div></div></div>',
								);
	return $form;
}

function get_order_alc_dlc(){
	global $base_root, $base_path, $user;
	$uid					=	$user->uid;
	$count					=	0;
			
	$sub_div_query			=	db_query('select district_code, sub_div_code from l_customuser_relation_address where user_id=:uid', array(':uid' => trim($uid) ));
	$sub_div_res			=	$sub_div_query->fetchAssoc();
	$dist_code 				= 	$sub_div_res['district_code'];
	$sub_division_code		=	$sub_div_res['sub_div_code'];		
		
	$output = 	'';	
	
	$header = 	array(
						array('data' => 'SL.No.', 'field' => '', 'width' => '5%'),
						array('data' => 'Order No.', 'field' => '', 'width' => '20%'),
						array('data' => 'Generated By', 'field' => '', 'width' => '30%', 'sort' => 'ASC'),
						array('data' => 'Published Date', 'field' => '', 'width' => '25%'),
						array('data' => 'Download', 'field' => '', 'width' => '20%')
					);
																		
	if($dist_code!=17 && $sub_division_code != 171001){		
		$query_1 = db_query('select signed_order_doc, order_uploaded_on, upload_status, order_no, tag_map_id from l_area_inspector_random_order_master where distict_code=:distict_code and subdivision_code=:subdivision_code and officer_designation=1 order by id DESC', array(':distict_code' => $dist_code, ':subdivision_code' => $sub_division_code ));
		
		if( $query_1->rowCount() > 0 ){
			
			while($data = $query_1->fetchObject()) {
				$count++;
				
				$signed_order_doc		=	$data->signed_order_doc;
				$order_uploaded_on		=	$data->order_uploaded_on;
				$upload_status			=	$data->upload_status;
				
				if($upload_status=="Y"){
					$DLC_order	= l('Download DLC Order', $base_root.$base_path.'sites/default/files/upload/randomizationorder/'.$signed_order_doc, array('html' => TRUE,'attributes'=>array('target' => '_blank')));
				}
				$rows[] = 	array(
									$count,
									$data->order_no.'<br>'.view_order_number_ins($dist_code, $sub_division_code, $data->tag_map_id),
									'Deputy Labour Commissione <br>'.'Assistant Labour Commissioner',
									'<strong>Uploaded Date:</strong> '.date('d/m/Y', strtotime($order_uploaded_on)).'<br>'.'<strong>Uploaded Date:</strong> '.view_order_date_ins($dist_code, $sub_division_code, $data->tag_map_id).'',
									$DLC_order.'<br>'.view_order_status_ins($dist_code, $sub_division_code, $data->tag_map_id)
								);
			}
		}
		
	}
	$variables 						= 	array( 'header' => $header, 'rows' => $rows, 'attributes' => array('class' => array('table table-striped table-responsive admin-custom-table')), 'empty' => t("No data found!"));
						
	$output 						= 	theme('datatable', $variables);
	return $output;
}

function view_order_number_ins($dist_code='', $sub_division_code='', $tag_map_id = ''){
	$query_2				=	db_query('select order_no from l_area_inspector_random_order_master where tag_map_id=:tag_dlc_map_id and distict_code=:distict_code and subdivision_code=:subdivision_code and officer_designation=2 order by id DESC', array(':distict_code' => $dist_code, ':subdivision_code' => $sub_division_code, ':tag_dlc_map_id' => $tag_map_id));
	if($query_2->rowCount()>0){
		foreach($query_2 as $val){
			$output	=	$val->order_no;
		}
	}else{
		$output	= 'Not Available';
	}
	return $output;
}

function view_order_date_ins($dist_code='', $sub_division_code='', $tag_map_id = ''){
	$query_2				=	db_query('select order_uploaded_on from l_area_inspector_random_order_master where tag_map_id=:tag_dlc_map_id and distict_code=:distict_code and subdivision_code=:subdivision_code and officer_designation=2 order by id DESC', array(':distict_code' => $dist_code, ':subdivision_code' => $sub_division_code, ':tag_dlc_map_id' => $tag_map_id));
	if($query_2->rowCount()>0){
		foreach($query_2 as $val){
			$output	=	date('d/m/Y', strtotime($val->order_uploaded_on));
		}
	}else{
		$output	= 'Not Available';
	}
	return $output;
}

function view_order_status_ins($dist_code='', $sub_division_code='', $tag_map_id = ''){
	$query_3				=	db_query('select signed_order_doc, upload_status from l_area_inspector_random_order_master where tag_map_id=:tag_dlc_map_id and distict_code=:distict_code and subdivision_code=:subdivision_code and officer_designation=2 order by id DESC', array(':distict_code' => $dist_code, ':subdivision_code' => $sub_division_code, ':tag_dlc_map_id' => $tag_map_id));
	if($query_3->rowCount()>0){
		foreach($query_3 as $val1){
			$output1	=	$val1->upload_status;
			if($output1=="Z"){
				$output_f	=	l('Download ALC Order', $base_root.$base_path.'sites/default/files/upload/randomizationalcorder/'.$val1->signed_order_doc, array('html' => TRUE,'attributes'=>array('target' => '_blank')));
			}
		}
	}else{
		$output_f	= 'Not Available';
	}
	return $output_f;
}
?>