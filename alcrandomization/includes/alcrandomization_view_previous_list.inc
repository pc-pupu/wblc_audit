<?php

function alcrandomization_view_previous_list($form, &$form_state){
	
	$markupLink				=	getTable();
	
	$form['markup-link']	=	array(
									'#type'		=>	'markup',
									'#markup'	=>	$markupLink
								);
	return $form;
}

function getTable(){
	global $base_root, $base_path, $user;
	$uid					=	$user->uid;
	$count					=	0;
	$query_alc_type			=	db_query('select area_division_type from l_custom_user_detail where usr_id =:uid', array(':uid' => trim($uid) ));
	$result					=	$query_alc_type->fetchAssoc();
	$area_division_type 	= 	$result['area_division_type'];
	$order					=	'inspector_id';
	$sort					=	'ASC';
	$show_details_query 	= 	db_select('l_area_inspector_random_tag', 't');
	$show_details_query		->	join('l_custom_user_detail', 'v', 'v.usr_id =  t.inspector_id');
	$show_details_query		->	fields('t', array('inspector_name','inspector_code','distict_code','block_municipality_code','inspector_id', 'id'));
	$show_details_query		->	condition('t.is_confirm','C','=');
	$show_details_query		->	condition('v.created_by', trim($uid), '=');
	$show_details_query		->	orderBy($order, $sort);
	$show_details_query 	= 	$show_details_query->extend('PagerDefault')->limit(50);
	$total_name 			=  	$show_details_query->execute();
	$row_arr 				= 	$total_name->fetchAssoc();
	$numrow 				= 	$total_name->rowCount();
	$dist_code 				= 	$row_arr['distict_code'];
	
	$sub_div_query			=	db_query('select sub_div_code from l_customuser_relation_address where user_id=:uid', array(':uid' => trim($uid) ));
	$sub_div_res			=	$sub_div_query->fetchAssoc();
	$sub_division_code		=	$sub_div_res['sub_div_code'];
		
	drupal_add_css(drupal_get_path('module', 'applicant_forms') . '/css/clra_applications.css');
	
	$output 						= 	'';	
	
	$header 						= 	array(
											array('data' => 'SL.No.', 'field' => '', 'width' => '8%'),
											array('data' => 'Order No.', 'field' => '', 'width' => '20%'),
											array('data' => 'Generated By', 'field' => '', 'width' => '30%', 'sort' => 'ASC'),
											array('data' => 'Published Date', 'field' => '', 'width' => '25%'),
											array('data' => 'Download', 'field' => '', 'width' => '20%')
										);
																		
	if($dist_code!=17 && $sub_division_code != 171001){
		//echo $dist_code."--".$sub_division_code; exit;
		$query_1 = db_query('select signed_order_doc, order_uploaded_on, upload_status, order_no, tag_map_id from l_area_inspector_random_order_master where distict_code=:distict_code and subdivision_code=:subdivision_code and officer_designation=1 order by id DESC', array(':distict_code' => $dist_code, ':subdivision_code' => $sub_division_code ));
		//print_r($query_1); exit;
		if( $query_1->rowCount() > 0 ){
			//echo "hii"; exit;
			while($data = $query_1->fetchObject()) {
				$count++;
				
				$signed_order_doc		=	$data->signed_order_doc;
				$order_uploaded_on		=	$data->order_uploaded_on;
				$upload_status			=	$data->upload_status;
				
				if($upload_status=="Y"){
					$DLC_order	=	l('Download DLC Order', $base_root.$base_path.'sites/default/files/upload/randomizationorder/'.$signed_order_doc, array('html' => TRUE,'attributes'=>array('target' => '_blank')));
				}
				$rows[] = 	array(
								$count,
								$data->order_no.'<br>'.get_uploaded_alc_number($dist_code, $sub_division_code, $data->tag_map_id),
								'Deputy Labour Commissione <br>'.'Assistant Labour Commissioner',
								'Uploaded Date: '.date('d/m/Y', strtotime($order_uploaded_on)).'<br>'.'Uploaded Date: '.get_uploaded_alc_date($dist_code, $sub_division_code, $data->tag_map_id).'',
								$DLC_order.'<br>'.get_uploaded_alc_order($dist_code, $sub_division_code, $data->tag_map_id)
							);
			}
		}
		
	}
	$variables = 	array( 'header' => $header, 'rows' => $rows, 'attributes' => array('class' => array('table table-striped table-responsive admin-custom-table')), 'empty' => t("Data not found!"));						
	$output = theme('datatable', $variables);
	return $output;
}

function get_uploaded_alc_number($dist_code='', $sub_division_code='', $tag_map_id = ''){
	$query_2				=	db_query('select order_no from l_area_inspector_random_order_master where tag_map_id=:tag_dlc_map_id and distict_code=:distict_code and subdivision_code=:subdivision_code and officer_designation=2 order by id DESC', array(':distict_code' => $dist_code, ':subdivision_code' => $sub_division_code, ':tag_dlc_map_id' => $tag_map_id));
	if($query_2->rowCount()>0){
		foreach($query_2 as $val){
			$output	=	$val->order_no;
		}
	}else{
		$output	= 'Not Available';
	}
	return $output;
}

function get_uploaded_alc_date($dist_code='', $sub_division_code='', $tag_map_id = ''){
	$query_2				=	db_query('select order_uploaded_on from l_area_inspector_random_order_master where tag_map_id=:tag_dlc_map_id and distict_code=:distict_code and subdivision_code=:subdivision_code and officer_designation=2 order by id DESC', array(':distict_code' => $dist_code, ':subdivision_code' => $sub_division_code, ':tag_dlc_map_id' => $tag_map_id));
	if($query_2->rowCount()>0){
		$result = $query_2->fetchObject();
		$output	=	date('d/m/Y', strtotime($result->order_uploaded_on));
	}else{
		$output	= 'Not Available';
	}
	return $output;
}

function get_uploaded_alc_order($dist_code='', $sub_division_code='', $tag_map_id = ''){
	$query_3				=	db_query('select signed_order_doc, upload_status from l_area_inspector_random_order_master where tag_map_id=:tag_dlc_map_id and distict_code=:distict_code and subdivision_code=:subdivision_code and officer_designation=2 order by id DESC', array(':distict_code' => $dist_code, ':subdivision_code' => $sub_division_code, ':tag_dlc_map_id' => $tag_map_id));
	if($query_3->rowCount()>0){
		foreach($query_3 as $val1){
			$output1	=	$val1->upload_status;
			if($output1=="Z"){
				$output_f	=	l('Download ALC Order', $base_root.$base_path.'sites/default/files/upload/randomizationalcorder/'.$val1->signed_order_doc, array('html' => TRUE,'attributes'=>array('target' => '_blank')));
			}
		}
	}else{
		$output_f	= 'Not Available';
	}
	return $output_f;
}